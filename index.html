<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godot Eval Pro - Sistema de Evaluaci√≥n e IA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Luckiest+Guy&family=Quicksand:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Librer√≠as Externas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        body { 
            font-family: 'Quicksand', sans-serif; 
            background-image: linear-gradient(rgba(15, 23, 42, 0.92), rgba(15, 23, 42, 0.92)), 
                              url('https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=2070');
            background-size: cover; background-position: center; background-attachment: fixed;
            color: white; min-height: 100vh;
        }
        .header-font { font-family: 'Luckiest Guy', cursive; }
        .card-glass { background: rgba(30, 41, 59, 0.75); backdrop-filter: blur(14px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .btn-user { background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); transition: 0.2s; }
        .btn-user.active { background-color: #10b981; border-color: #34d399; box-shadow: 0 0 15px rgba(16, 185, 129, 0.4); }
        .master-mode-active { border: 2px solid #ef4444 !important; box-shadow: 0 0 40px rgba(239, 68, 68, 0.3); }
        
        /* Estilo para la captura del PDF */
        .pdf-mode {
            background: #0f172a !important;
            backdrop-filter: none !important;
            box-shadow: none !important;
            color: white !important;
            padding: 20px !important;
        }
        .pdf-mode * { text-shadow: none !important; }
        .pdf-mode .no-print { display: none !important; }

        input.student-input { 
            background: rgba(0,0,0,0.5) !important; 
            color: white !important; 
            border: 1px solid rgba(255, 255, 255, 0.2) !important; 
            border-radius: 6px; 
            padding: 2px 8px; 
            outline: none;
            overflow-x: auto;
            white-space: nowrap;
        }
        
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-left-color: #fbbf24;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; color: black !important; background-image: none !important; }
            .card-glass { background: white !important; color: black !important; backdrop-filter: none !important; border: 1px solid #ccc !important; }
            .bg-gradient-to-r { background: #eee !important; color: black !important; }
            #final-grade { background: #ddd !important; border: 2px solid black !important; color: black !important; }
        }

        /* Modales */
        .modal-overlay {
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
        }
    </style>
</head>
<body class="p-4 md:p-10 flex flex-col items-center">

    <!-- Modal de Contrase√±a -->
    <div id="password-modal" class="fixed inset-0 z-[100] flex items-center justify-center hidden no-print modal-overlay">
        <div class="bg-slate-800 border-2 border-indigo-500 p-6 rounded-3xl shadow-2xl w-80 text-center">
            <h3 class="header-font text-xl text-white mb-4 uppercase tracking-widest">Acceso Docente</h3>
            <input type="password" id="docente-pass-input" class="w-full bg-black/40 border border-white/20 rounded-xl px-4 py-2 text-white text-center mb-4 outline-none focus:border-indigo-400" placeholder="Introduce la clave">
            <div class="flex gap-2">
                <button onclick="closePassModal()" class="flex-1 bg-white/10 hover:bg-white/20 py-2 rounded-xl text-xs font-bold uppercase">Cancelar</button>
                <button onclick="checkPass()" class="flex-1 bg-indigo-600 hover:bg-indigo-500 py-2 rounded-xl text-xs font-bold uppercase">Entrar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Borrado -->
    <div id="delete-modal" class="fixed inset-0 z-[110] flex items-center justify-center hidden no-print modal-overlay">
        <div class="bg-slate-800 border-2 border-red-500 p-6 rounded-3xl shadow-2xl w-80 text-center">
            <h3 class="header-font text-xl text-white mb-2 uppercase tracking-widest">¬øEliminar?</h3>
            <p class="text-xs text-slate-300 mb-6 uppercase font-bold italic">Esta acci√≥n no se puede deshacer.</p>
            <div class="flex gap-2">
                <button onclick="closeDeleteModal()" class="flex-1 bg-white/10 hover:bg-white/20 py-2 rounded-xl text-xs font-bold uppercase">No, volver</button>
                <button onclick="confirmDelete()" class="flex-1 bg-red-600 hover:bg-red-500 py-2 rounded-xl text-xs font-bold uppercase text-white">S√≠, borrar</button>
            </div>
        </div>
    </div>

    <!-- Selector de Roles -->
    <div class="no-print mb-6 flex gap-4 bg-black/40 p-2 rounded-2xl border border-white/10 shadow-lg">
        <button onclick="changeToUser()" id="mode-user-btn" class="px-6 py-1.5 rounded-xl font-bold transition-all bg-indigo-600 text-sm">Alumno</button>
        <button onclick="openPassModal()" id="mode-master-btn" class="px-6 py-1.5 rounded-xl font-bold transition-all hover:bg-white/10 text-sm">Docente üîí</button>
    </div>

    <div id="main-card" class="w-full max-w-4xl card-glass rounded-[2.5rem] overflow-hidden shadow-2xl transition-all duration-500">
        
        <!-- Cabecera -->
        <div class="relative bg-gradient-to-r from-indigo-600/90 to-purple-800/90 p-8 text-center border-b border-white/10">
            <h1 id="app-title" class="header-font text-4xl md:text-5xl text-white drop-shadow-2xl uppercase tracking-widest leading-tight">PROYECTO VIDEOJUEGO CON GODOT</h1>
            <p id="mode-label" class="mt-2 text-indigo-200 font-bold uppercase text-[10px] tracking-[0.5em]">Evaluaci√≥n de Software</p>
            <div id="current-date-display" class="absolute bottom-2 right-4 text-[10px] font-bold text-white/50 uppercase tracking-widest">
                FECHA: --/--/----
            </div>
        </div>

        <!-- Alumno e Inspiraci√≥n -->
        <div class="p-6 md:px-10 bg-white/5 border-b border-white/10 flex justify-center">
            
            <!-- SECCI√ìN DATOS ALUMNO + FRASES REPOSICIONADOS -->
            <div class="flex flex-row items-center gap-8">
                
                <!-- Frase a la IZQUIERDA -->
                <div class="hidden md:block border-r border-white/10 pr-8 text-right">
                    <p class="text-yellow-400 font-bold italic text-[11px] md:text-[13px] leading-tight max-w-[200px]">
                        "Un gran desarrollador se hace l√≠nea por l√≠nea."
                    </p>
                </div>

                <!-- Casillas de Nombre y Apellido Centradas -->
                <div class="flex gap-4">
                    <div class="w-24 md:w-32">
                        <label class="block text-[9px] uppercase font-black text-indigo-300 mb-1 ml-1 tracking-wider">Nombre</label>
                        <input type="text" id="student-name" placeholder="Nombre" class="student-input w-full text-[11px] focus:border-indigo-500 transition-all py-1.5">
                    </div>
                    <div class="w-24 md:w-32">
                        <label class="block text-[9px] uppercase font-black text-indigo-300 mb-1 ml-1 tracking-wider">Apellido</label>
                        <input type="text" id="student-surname" placeholder="Apellido" class="student-input w-full text-[11px] focus:border-indigo-500 transition-all py-1.5">
                    </div>
                </div>

            </div>
        </div>

        <!-- Tabla -->
        <div class="p-4 md:p-8">
            <table class="w-full text-left border-separate border-spacing-y-3">
                <thead>
                    <tr class="text-indigo-400 uppercase text-[10px] font-black tracking-widest">
                        <th class="px-4 py-2">Criterio de Evaluaci√≥n</th>
                        <th class="px-4 py-2 text-center w-24 no-print-val" id="val-header" style="display:none">Puntos</th>
                        <th class="px-4 py-2 text-center w-32 no-print">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody id="criteria-list"></tbody>
            </table>

            <div id="master-controls" class="hidden no-print mt-6 flex flex-wrap justify-center gap-4 border-t border-white/10 pt-6">
                <div class="w-full grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="text-center">
                        <label class="text-[10px] font-black text-indigo-300 uppercase tracking-widest block mb-1">Escala de Calificaci√≥n</label>
                        <input type="text" id="edit-scale-input" class="bg-black/30 border border-white/20 rounded-lg px-4 py-1 text-xs text-center w-full max-w-xs text-yellow-200 mx-auto block" placeholder="Ej: (Esc: 1 al 10)">
                    </div>
                    <div class="text-center">
                        <label class="text-[10px] font-black text-indigo-300 uppercase tracking-widest block mb-1">Gemini API Key üîë</label>
                        <input type="password" id="edit-api-key" class="bg-black/30 border border-white/20 rounded-lg px-4 py-1 text-xs text-center w-full max-w-xs text-green-300 mx-auto block" placeholder="Pega tu API Key aqu√≠">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-[8px] text-indigo-400 hover:underline uppercase mt-1 block">¬øNo tienes una? Cons√≠guela aqu√≠</a>
                    </div>
                </div>
                <div class="flex gap-3 justify-center w-full">
                    <button onclick="addItem()" class="bg-blue-600 hover:bg-blue-500 px-5 py-2 rounded-2xl font-bold text-xs shadow-lg transition-all">+ A√ëADIR CRITERIO</button>
                    <button onclick="saveChanges()" class="bg-green-600 hover:bg-green-500 px-6 py-2 rounded-2xl font-bold text-xs shadow-xl transition-all border-b-4 border-green-800 active:border-b-0 active:translate-y-1">üíæ GUARDAR CONFIGURACI√ìN</button>
                </div>
            </div>
        </div>

        <!-- IA Output -->
        <div id="ai-section" class="hidden px-8 py-6 bg-indigo-900/40 border-t border-white/10">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <span id="ai-header-title" class="header-font text-xl text-yellow-400 uppercase tracking-tighter">Asistencia IA ‚ú®</span>
                    <div id="ai-loader" class="loader hidden"></div>
                </div>
                <button onclick="document.getElementById('ai-section').classList.add('hidden')" class="text-xs text-indigo-300 hover:text-white uppercase font-bold no-print">Cerrar</button>
            </div>
            <div id="ai-output" class="text-sm text-indigo-50 leading-relaxed bg-black/30 p-6 rounded-2xl border border-indigo-500/30 whitespace-pre-line italic">
                Genera un informe para ver los detalles aqu√≠.
            </div>
        </div>

        <!-- Footer Resultados -->
        <div class="bg-black/40 p-6 md:p-10 flex flex-row items-center justify-between border-t border-white/10 gap-4">
            <div class="flex flex-col items-start">
                <p class="header-font text-lg md:text-2xl text-indigo-300 leading-none">Puntos Totales</p>
                <div id="points-counter" class="text-4xl md:text-6xl font-black text-white mt-1 leading-none">0 / 14</div>
            </div>
            <div class="flex flex-row items-center gap-4">
                <div class="flex flex-col items-end hidden sm:flex">
                    <p class="header-font text-xl md:text-4xl text-yellow-400 drop-shadow-lg leading-none">Nota Final</p>
                    <span id="grade-scale-display" class="text-[10px] md:text-xs text-yellow-200/60 font-light tracking-wide mt-1 uppercase italic"></span>
                </div>
                <div id="final-grade" class="header-font text-5xl md:text-7xl text-white bg-slate-800/80 px-8 md:px-12 py-3 md:py-4 rounded-2xl shadow-2xl min-w-[100px] md:min-w-[150px] text-center border-4 border-yellow-500 transition-all leading-none">
                    -
                </div>
            </div>
        </div>

        <!-- Pie de Autor√≠a y Copyright -->
        <div class="bg-black/60 p-3 text-center border-t border-white/5">
            <p class="text-[10px] font-bold text-white/40 uppercase tracking-[0.2em] flex items-center justify-center gap-2">
                <span>¬©</span>
                <span>Creado por Daniel Morisio</span>
                <span class="text-indigo-400">|</span>
                <span>Todos los derechos reservados</span>
                <span class="text-yellow-500">üîí</span>
            </p>
        </div>
    </div>

    <!-- Acciones -->
    <div class="no-print mt-8 flex flex-wrap justify-center gap-3 pb-10">
        <button onclick="exportToPDF('Evaluacion')" class="bg-white/10 hover:bg-white/20 px-5 py-2.5 rounded-2xl font-bold text-[10px] uppercase tracking-widest transition-all">üñ®Ô∏è Imprimir PDF</button>
        <button onclick="shareResults()" class="bg-blue-600/20 hover:bg-blue-600/40 px-5 py-2.5 rounded-2xl font-bold text-[10px] uppercase tracking-widest transition-all">üîó Compartir</button>
        <button onclick="generateAIReport('report')" class="bg-purple-600 hover:bg-purple-500 px-5 py-2.5 rounded-2xl font-bold text-[10px] uppercase tracking-widest transition-all shadow-lg shadow-purple-900/20">Informe IA ‚ú®</button>
        <button onclick="generateAIReport('tips')" class="bg-yellow-500 hover:bg-yellow-400 px-5 py-2.5 rounded-2xl font-bold text-[10px] uppercase tracking-widest text-black transition-all shadow-lg shadow-yellow-900/20">TIPS IA ‚ú®</button>
        <button onclick="saveToExcel()" class="bg-green-600 hover:bg-green-500 px-8 py-2.5 rounded-2xl font-bold text-xs uppercase tracking-widest shadow-xl border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">üíæ Guardar Evaluaci√≥n</button>
    </div>

    <div id="toast" class="fixed bottom-10 bg-green-500 text-white px-8 py-4 rounded-2xl font-bold shadow-2xl opacity-0 transition-opacity duration-300 pointer-events-none z-50"></div>

    <script>
        const MASTER_PASSWORD = "godot123"; 

        let appData = {
            title: "PROYECTO VIDEOJUEGO CON GODOT",
            gradeScaleText: "(Esc: 1 al 10)",
            geminiKey: "", // Almacenaremos la clave aqu√≠
            criteria: [
                { text: "Movimiento del Player (Derecha/Izquierda)", val: 1 },
                { text: "Salto simple funcional", val: 1 },
                { text: "Doble salto implementado", val: 1 },
                { text: "Barra de energ√≠a funcional (HUD)", val: 1 },
                { text: "Vidas con corazones", val: 1 },
                { text: "Enemigos o trampas que generen da√±o", val: 1 },
                { text: "P√©rdida de energ√≠a/vida al recibir da√±o", val: 1 },
                { text: "Game Over al perder todas las vidas", val: 1 },
                { text: "Movimiento y saltos suaves", val: 1 },
                { text: "Escenario con fondo y decoraci√≥n", val: 1 },
                { text: "Coherencia visual (Sprites y UI)", val: 1 },
                { text: "Funcionalidad sin errores graves", val: 1 },
                { text: "Mejoras creativas (Animaciones/Sonidos)", val: 1 },
                { text: "Documentaci√≥n o l√≥gica programada", val: 1 }
            ]
        };

        let userProgress = [];
        let isMasterMode = false;
        let indexToDelete = -1;

        function setDate() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            document.getElementById('current-date-display').innerText = `FECHA: ${day}/${month}/${year}`;
        }

        if (localStorage.getItem('godotMasterConfig')) {
            const saved = JSON.parse(localStorage.getItem('godotMasterConfig'));
            appData = { ...appData, ...saved };
        }
        
        userProgress = new Array(appData.criteria.length).fill(false);

        // Funciones de Clave
        window.openPassModal = () => {
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('docente-pass-input').focus();
        };

        window.closePassModal = () => {
            document.getElementById('password-modal').classList.add('hidden');
            document.getElementById('docente-pass-input').value = "";
        };

        window.checkPass = () => {
            const pass = document.getElementById('docente-pass-input').value;
            if (pass === MASTER_PASSWORD) {
                isMasterMode = true;
                updateUI();
                closePassModal();
                showToast("üîì Modo Docente Activo");
            } else {
                showToast("‚ùå Clave Incorrecta");
                document.getElementById('docente-pass-input').value = "";
            }
        };

        document.getElementById('docente-pass-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkPass();
        });

        window.removeItem = (i) => {
            indexToDelete = i;
            document.getElementById('delete-modal').classList.remove('hidden');
        };

        window.closeDeleteModal = () => {
            document.getElementById('delete-modal').classList.add('hidden');
            indexToDelete = -1;
        };

        window.confirmDelete = () => {
            if (indexToDelete > -1) {
                appData.criteria.splice(indexToDelete, 1);
                userProgress.splice(indexToDelete, 1);
                showToast("üóëÔ∏è Criterio eliminado");
                render();
            }
            closeDeleteModal();
        };

        window.changeToUser = () => { 
            isMasterMode = false; 
            updateUI(); 
            showToast("üë§ Modo Alumno Activo");
        };

        function updateUI() {
            document.getElementById('mode-user-btn').classList.toggle('bg-indigo-600', !isMasterMode);
            document.getElementById('mode-master-btn').classList.toggle('bg-red-600', isMasterMode);
            document.getElementById('main-card').classList.toggle('master-mode-active', isMasterMode);
            document.getElementById('master-controls').classList.toggle('hidden', !isMasterMode);
            
            if (isMasterMode) {
                document.getElementById('edit-scale-input').value = appData.gradeScaleText;
                document.getElementById('edit-api-key').value = appData.geminiKey || "";
            }
            
            render();
        }

        function render() {
            const titleEl = document.getElementById('app-title');
            titleEl.innerHTML = isMasterMode ? `<input type="text" value="${appData.title}" id="edit-title" class="w-full bg-transparent text-center border-none outline-none">` : appData.title;
            
            document.getElementById('grade-scale-display').innerText = appData.gradeScaleText;
            
            document.getElementById('val-header').style.display = isMasterMode ? 'table-cell' : 'none';
            const container = document.getElementById('criteria-list');
            container.innerHTML = appData.criteria.map((item, i) => `
                <tr class="bg-white/5 hover:bg-white/10 transition-all">
                    <td class="p-4 ${userProgress[i] ? 'text-green-400 font-bold' : ''}">
                        ${isMasterMode ? `<input type="text" value="${item.text}" id="text-${i}" class="w-full text-sm font-bold bg-transparent outline-none border-b border-white/10 focus:border-indigo-500 transition-colors">` : `<span class="text-sm font-bold">${i + 1}. ${item.text}</span>`}
                    </td>
                    <td class="p-4 text-center ${isMasterMode ? '' : 'hidden'}">
                        <input type="number" value="${item.val}" id="val-${i}" class="w-16 text-center text-sm bg-black/20 rounded border border-white/10">
                    </td>
                    <td class="p-4 text-center no-print">
                        ${isMasterMode ? `<button onclick="removeItem(${i})" class="text-red-400 text-[10px] font-black uppercase hover:text-red-300 transition-colors">Borrar</button>` : `<button onclick="toggleCheck(${i})" class="btn-user w-full py-2 rounded-xl font-black text-[10px] uppercase ${userProgress[i] ? 'active' : ''}">${userProgress[i] ? '‚úì SI' : 'Cumple'}</button>`}
                    </td>
                </tr>
            `).join('');
            calculate();
        }

        window.saveChanges = () => {
            appData.title = document.getElementById('edit-title').value;
            appData.gradeScaleText = document.getElementById('edit-scale-input').value || "(Esc: 1 al 10)";
            appData.geminiKey = document.getElementById('edit-api-key').value.trim();
            
            appData.criteria.forEach((item, i) => {
                const textInput = document.getElementById(`text-${i}`);
                const valInput = document.getElementById(`val-${i}`);
                if (textInput && valInput) {
                    item.text = textInput.value;
                    item.val = parseFloat(valInput.value) || 0;
                }
            });
            
            localStorage.setItem('godotMasterConfig', JSON.stringify(appData));
            showToast("‚úÖ Configuraci√≥n guardada localmente");
            render();
        };

        window.toggleCheck = (i) => { userProgress[i] = !userProgress[i]; render(); };
        window.addItem = () => { appData.criteria.push({text: "Nuevo criterio", val: 1}); userProgress.push(false); render(); };

        function calculate() {
            let logrados = 0; let max = 0;
            appData.criteria.forEach((item, i) => {
                max += item.val;
                if (!isMasterMode && userProgress[i]) logrados += item.val;
            });

            document.getElementById('points-counter').innerText = `${logrados.toFixed(1)} / ${max.toFixed(1)}`;
            
            let nota = max > 0 && !isMasterMode ? Math.max(1, Math.round((logrados / max) * 10)) : "-";
            if (logrados === 0) nota = "-";
            const gradeBox = document.getElementById('final-grade');
            gradeBox.innerText = nota;
            gradeBox.className = "header-font text-5xl md:text-7xl text-white bg-slate-800/80 px-8 md:px-12 py-3 md:py-4 rounded-2xl shadow-2xl min-w-[100px] md:min-w-[150px] text-center border-4 border-yellow-500 transition-all leading-none " + 
                (nota >= 8 ? "bg-green-600/80" : nota >= 6 ? "bg-orange-600/80" : nota >= 1 ? "bg-red-600/80" : "bg-slate-800/80");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.opacity = '1';
            setTimeout(() => t.style.opacity = '0', 4000);
        }

        window.saveToExcel = () => {
            const name = document.getElementById('student-name').value;
            const surname = document.getElementById('student-surname').value;
            if (!name.trim() || !surname.trim()) { showToast("‚ö†Ô∏è Escribe nombre y apellido para guardar"); return; }

            const fullName = `${name} ${surname}`;
            const dateStr = document.getElementById('current-date-display').innerText.split(': ')[1];
            const nota = document.getElementById('final-grade').innerText;
            const puntos = document.getElementById('points-counter').innerText;
            const aiContent = document.getElementById('ai-output').innerText;

            const data = [
                ["INFORME DE EVALUACI√ìN - GODOT"],
                ["Alumno:", fullName], ["Fecha:", dateStr],
                ["Proyecto:", appData.title],
                ["Escala:", appData.gradeScaleText],
                [""], ["CHECKLIST"], ["Criterio", "Puntaje", "Estado"]
            ];
            appData.criteria.forEach((c, i) => {
                data.push([c.text, c.val, userProgress[i] ? "CUMPLIDO" : "PENDIENTE"]);
            });
            data.push([""], ["Puntos Totales:", puntos], ["Nota Final:", nota], [""], ["IA:", aiContent]);
            data.push([""], ["¬© Creado por Daniel Morisio"]);

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Evaluaci√≥n");
            XLSX.writeFile(wb, `Evaluacion_${fullName.replace(/\s+/g, '_')}.xlsx`);
            showToast("‚úÖ Excel guardado");
        };

        async function exportToPDF(tipo = "Evaluacion") {
            const card = document.getElementById('main-card');
            const name = document.getElementById('student-name').value || "Estudiante";
            const filename = `${tipo}_Godot_${name}.pdf`.replace(/\s+/g, '_');
            const aiSection = document.getElementById('ai-section');
            const wasHidden = aiSection.classList.contains('hidden');
            if (tipo === "Completa") aiSection.classList.remove('hidden');

            showToast(`‚è≥ Generando PDF...`);
            card.classList.add('pdf-mode');

            const options = {
                margin: 0.3, filename: filename, image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, backgroundColor: '#0f172a', scrollY: 0 },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            try {
                await new Promise(r => setTimeout(r, 400));
                await html2pdf().set(options).from(card).save();
                showToast("‚úÖ PDF generado");
            } catch (err) { showToast("‚ùå Error PDF"); }
            finally { 
                card.classList.remove('pdf-mode'); 
                if (wasHidden && tipo === "Completa") aiSection.classList.add('hidden');
            }
        }

        async function generateAIReport(type) {
            const output = document.getElementById('ai-output');
            const section = document.getElementById('ai-section');
            const loader = document.getElementById('ai-loader');
            const name = document.getElementById('student-name').value || "Estudiante";
            const fullName = `${name}`.trim();

            if (!appData.geminiKey) {
                showToast("üîë Falta API Key. Ve al Modo Docente.");
                section.classList.remove('hidden');
                output.innerHTML = "Error: No se ha configurado la API Key de Gemini.<br><br>Para usar la IA en GitHub:<br>1. Pulsa el bot√≥n 'Docente' e introduce la clave (godot123).<br>2. Pega tu API Key de Gemini en el nuevo campo de configuraci√≥n.<br>3. Pulsa 'Guardar Configuraci√≥n'.";
                return;
            }

            section.classList.remove('hidden');
            loader.classList.remove('hidden');
            output.innerText = "IA pensando...";

            const cumplidos = appData.criteria.filter((_, i) => userProgress[i]).map(c => c.text);
            const pendientes = appData.criteria.filter((_, i) => !userProgress[i]).map(c => c.text);
            const nota = document.getElementById('final-grade').innerText;

            let prompt = type === 'report' 
                ? `INFORME para "${fullName}" (Nota ${nota}). T√≠tulos en MAY√öSCULAS: RESUMEN:, LOGROS:, MEJORAS:, CONCLUSI√ìN:. M√°ximo 2 l√≠neas por punto. Nada de Markdown (###, **).`
                : `TIPS SIMPLES para: ${pendientes.join(', ')}. Breve, sin Markdown.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${appData.geminiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "Eres un mentor de Godot experto. No uses Markdown." }] }
                    })
                });
                
                if (!response.ok) throw new Error("API Key inv√°lida o error de servidor.");
                
                const result = await response.json();
                output.innerText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sin respuesta.";
            } catch (err) { 
                output.innerText = "Error: " + err.message + ". Verifica tu API Key en el Modo Docente."; 
            }
            finally { loader.classList.add('hidden'); }
        }

        window.shareResults = async () => {
            const text = `üéÆ Proyecto Godot\n‚≠ê Nota: ${document.getElementById('final-grade').innerText}/10`;
            if (navigator.share) { await navigator.share({ text }); }
        };

        window.onload = function() { setDate(); updateUI(); }
    </script>
</body>
</html>
